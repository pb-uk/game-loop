<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Game loop example</title>
    <link rel="stylesheet" href="css/styles.css?v=1.0" />
    <script
      defer
      onload="gameLoopLoaded()"
      src="../dist/game-loop.min.js"
    ></script>
  </head>

  <body>
    <div><button id="start">Start</button></div>
    <div><button id="stop">Stop</button></div>
    <div><button id="reset">Reset</button></div>
    <pre id="app"></pre>
    <div
      style="position: relative; width: 300px; height: 300px; background: #eee"
    >
      <svg
        style="
          position: absolute;
          width: 2px;
          height: 2px;
          bottom: 149px;
          left: 149px;
        "
      >
        <circle r="1" cx="1" cy="1" />
      </svg>
      <svg id="point" style="position: absolute; width: 2px; height: 2px">
        <circle r="1" cx="1" cy="1" />
      </svg>
    </div>

    <script>
      /*
    const gameLoopLoaded = () => {
      const render = () => {
        document.getElementById('app').textContent = new Date().toISOString();
      };
      const game = GameLoop.createGame({ render });
      game.run();
    };
    */

      const gameLoopLoaded = () => {
        const render = ({ state, frameLength }) => {
          const fps = frameLength ? Math.round((1 / frameLength) * 1000) : 0;
          const date = new Date().toISOString();

          document.getElementById('app').innerText = JSON.stringify(
            { date, fps, state },
            null,
            2
          );
          document.getElementById('point').style.bottom = `${
            150 + state.y * 100 - 1
          }px`;
          document.getElementById('point').style.left = `${
            150 + state.x * 100 - 1
          }px`;
        };

        const getInitialState = ({ r, v }) => {
          return {
            t: 0,
            x: r,
            y: 0,
            vx: 0,
            vy: v,
            r: null,
            theta: null,
            ke: null,
            pe: null,
            e: null,
          };
        };

        const update = ({ state, frameLength, config }) => {
          const { gm } = config;
          const { x, y } = state;
          const a = -gm * (x * x + y * y) ** (-3 / 2);
          const ax = a * x;
          const ay = a * y;
          state.vx += (ax * frameLength) / 1000;
          state.vy += (ay * frameLength) / 1000;
          state.x += (state.vx * frameLength) / 1000;
          state.y += (state.vy * frameLength) / 1000;
          state.ke = 0.5 * (state.vx ** 2 + state.vy ** 2);
          state.r = Math.sqrt(state.x ** 2 + state.y ** 2);
          state.pe = -gm / state.r;
          state.e = state.pe + state.ke;
          const angle = Math.atan2(state.y, state.x);
          state.theta = angle < 0 ? Math.PI * 2 + angle : angle;
          state.t += frameLength;
        };

        // Radius (arbitrary units).
        const r = 1;
        // Period (seconds).
        const p = 60;

        const config = {
          r,
          p,
          gm: (4 * Math.PI * Math.PI * r * r * r) / (p * p),
          v: (2 * Math.PI * r) / p,
        };

        const game = GameLoop.createGame({
          config,
          update,
          render,
          getInitialState,
        });
        // By default a game will be started running.
        document.getElementById('start').addEventListener('click', () => {
          game.start();
        });
        document.getElementById('stop').addEventListener('click', () => {
          game.stop();
        });
        document.getElementById('reset').addEventListener('click', () => {
          game.reset();
        });
      };
    </script>
  </body>
</html>
